!function(){function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{"+P1L":function(n,r,i){"use strict";i.r(r),i.d(r,"UsersModule",(function(){return x}));var a=i("ofXK"),s=i("tyNb"),o=i("mrSG"),c=i("D/fu"),u=i("RS3s"),l=i("lJxs"),d=i("H/qo"),f=i("6j+Z"),m=i("UgA8"),p=i("fXoL"),h=i("aceb");function b(e,t){if(1&e){var n=p["\u0275\u0275getCurrentView"]();p["\u0275\u0275elementStart"](0,"ng2-smart-table",6),p["\u0275\u0275listener"]("userRowSelect",(function(e){return p["\u0275\u0275restoreView"](n),p["\u0275\u0275nextContext"]().viewCustomer(e)}))("deleteConfirm",(function(e){return p["\u0275\u0275restoreView"](n),p["\u0275\u0275nextContext"]().onDeleteConfirm(e)}))("createConfirm",(function(e){return p["\u0275\u0275restoreView"](n),p["\u0275\u0275nextContext"]().onCreateConfirm(e)})),p["\u0275\u0275elementEnd"]()}if(2&e){var r=p["\u0275\u0275nextContext"]();p["\u0275\u0275property"]("settings",r.settings)("source",r.source)}}var g,v,w,y=[{path:"",component:(g=function(){function n(t,r,i,a,s,o){e(this,n),this.usersApi=t,this.router=r,this.toast=i,this.roleMapping=a,this.roleApi=s,this.courierService=o,this.settings={add:{inputClass:"text-black",confirmCreate:!0,addButtonContent:'<i class="nb-plus"></i>',createButtonContent:'<i class="nb-checkmark"></i>',cancelButtonContent:'<i class="nb-close"></i>'},edit:{editButtonContent:'<i class="nb-edit"></i>',saveButtonContent:'<i class="nb-checkmark"></i>',cancelButtonContent:'<i class="nb-close"></i>'},actions:{edit:!1,position:"right"},delete:{deleteButtonContent:'<i class="nb-trash"></i>',confirmDelete:!0},columns:{id:{title:"Id",width:"0px",type:"number",filter:!1,editable:!1,addable:!1},role:{title:"Role",type:"string",filter:!1,editor:{type:"list",config:{list:[]}}},name:{title:"Name",type:"string",filter:!1},email:{title:"E-mail",type:"string",filter:!1},phoneNumber:{title:"Phone Number",type:"string",filter:!1}}},this.userListReady=!1,this.userRolesReady=!1,this.source=new u.b}var r,i,a;return r=n,(i=[{key:"ngOnInit",value:function(){this.getUsers(),this.getRoles()}},{key:"resetSearch",value:function(e){(!e||e<=2)&&this.source.setFilter([])}},{key:"onSearch",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";e.length<2||this.source.setFilter([{field:"name",search:e},{field:"mailboxNumber",search:e},{field:"email",search:e}],!1)}},{key:"pad",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,n=""+e;n.length<t;)n="0"+n;return n}},{key:"getRoles",value:function(){var e=this;this.roleApi.find().pipe(Object(l.a)((function(e){return e.map((function(e){return{value:e.id,title:e.name}}))}))).subscribe((function(t){e.userRolesReady=!0,e.settings.columns.role.editor.config.list=t}))}},{key:"getUsers",value:function(){var e=this;this.usersApi.getAdministrators(this.courierService.getRealm()).pipe(Object(l.a)((function(e){return e.map((function(e){return{id:e.id,name:"".concat(e.firstName," ").concat(e.lastName),email:e.email,phoneNumber:e.contactInformation.mobilePhone,role:e.roles.length>0?e.roles[0].name:""}}))}))).subscribe((function(t){e.userListReady=!0,e.source=new u.b(t)}),(function(t){e.toast.danger("Oops, something unexpected happened "+t.message,"Failed")}))}},{key:"viewCustomer",value:function(e){this.router.navigate(["/pages/customers",e.data.id])}},{key:"onDeleteConfirm",value:function(e){var t=this;window.confirm("Are you sure you want to revoke admin access for this user?")?this.roleMapping.findOne({where:{principalId:e.data.id}}).subscribe((function(n){t.roleMapping.deleteById(n.id).subscribe((function(n){t.toast.success("User access revoked","Success"),t.getUsers(),e.confirm.resolve()}),(function(n){t.toast.danger("Failed to delete user role "+n.message,"Failed"),e.confirm.reject()}))}),(function(n){t.toast.danger("Failed to find user role "+n.message,"Failed"),e.confirm.reject()})):e.confirm.reject()}},{key:"onCreateConfirm",value:function(e){return Object(o.a)(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n,r=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.newData.name){t.next=2;break}return t.abrupt("return",(this.toast.danger("First name is required","Add Customer Failed"),void e.confirm.reject()));case 2:if(e.newData.email){t.next=4;break}return t.abrupt("return",(this.toast.danger("Email name is required","Add Customer Failed"),void e.confirm.reject()));case 4:if(d.validate(e.newData.email)){t.next=6;break}return t.abrupt("return",(this.toast.danger("Email name is invalid","Add Customer Failed"),void e.confirm.reject()));case 6:if(e.newData.phoneNumber){t.next=8;break}return t.abrupt("return",(this.toast.danger("Phone number is invalid","Add Customer Failed"),void e.confirm.reject()));case 8:return t.prev=8,t.next=11,this.usersApi.findOne({where:{email:e.newData.email}}).toPromise();case 11:n=t.sent,t.next=17;break;case 14:t.prev=14,t.t0=t.catch(8),n=null;case 17:n?this.roleMapping.create({principalType:"USER",principalId:n.id,roleId:e.newData.role}).subscribe((function(t){r.toast.success("User was added to the team","Success!"),e.confirm.resolve()}),(function(t){r.toast.danger("Failed to assign user role","Failed!"),e.confirm.resolve()})):this.usersApi.create({email:e.newData.email,password:Math.random().toString(36).substr(2,11),realm:this.courierService.getRealm()}).subscribe((function(t){r.usersApi.patchAttributes(t.id,{firstName:e.newData.name.substr(0,e.newData.name.indexOf(" ")),lastName:e.newData.name.substr(e.newData.name.indexOf(" "),e.newData.name.length),contactInformation:{mobilePhone:e.newData.phoneNumber}}).subscribe((function(n){r.roleMapping.create({principalType:"USER",principalId:t.id,roleId:e.newData.role}).subscribe((function(t){r.toast.success("User successfully created and assigned to the team","Success!"),e.confirm.resolve()}),(function(t){r.toast.danger("Failed to assign user role","Failed!"),e.confirm.resolve()}))}),(function(t){r.toast.danger("Failed to update user profile "+t.mesage,"Failed!"),e.confirm.reject()}))}),(function(t){r.toast.danger("Failed to create user "+t.message,"Failed!"),e.confirm.reject()}));case 18:case"end":return t.stop()}}),t,this,[[8,14]])})))}}])&&t(r.prototype,i),a&&t(r,a),n}(),g.\u0275fac=function(e){return new(e||g)(p["\u0275\u0275directiveInject"](c.e),p["\u0275\u0275directiveInject"](s.c),p["\u0275\u0275directiveInject"](h.mb),p["\u0275\u0275directiveInject"](c.n),p["\u0275\u0275directiveInject"](f.a),p["\u0275\u0275directiveInject"](m.a))},g.\u0275cmp=p["\u0275\u0275defineComponent"]({type:g,selectors:[["ngx-users"]],decls:10,vars:1,consts:[[1,"search"],["placeholder","Search... Enter 3 or more characters","type","text","nbInput","",3,"input","keydown.enter"],["search",""],["nbSuffix","","nbButton","","ghost","",3,"click"],["icon","search-outline","pack","eva"],[3,"settings","source","userRowSelect","deleteConfirm","createConfirm",4,"ngIf"],[3,"settings","source","userRowSelect","deleteConfirm","createConfirm"]],template:function(e,t){if(1&e){var n=p["\u0275\u0275getCurrentView"]();p["\u0275\u0275elementStart"](0,"nb-card"),p["\u0275\u0275elementStart"](1,"nb-card-header"),p["\u0275\u0275text"](2," System Users "),p["\u0275\u0275elementEnd"](),p["\u0275\u0275elementStart"](3,"nb-card-body"),p["\u0275\u0275elementStart"](4,"nb-form-field",0),p["\u0275\u0275elementStart"](5,"input",1,2),p["\u0275\u0275listener"]("input",(function(){p["\u0275\u0275restoreView"](n);var e=p["\u0275\u0275reference"](6);return t.resetSearch(e.value.length)}))("keydown.enter",(function(){p["\u0275\u0275restoreView"](n);var e=p["\u0275\u0275reference"](6);return t.onSearch(e.value)})),p["\u0275\u0275elementEnd"](),p["\u0275\u0275elementStart"](7,"button",3),p["\u0275\u0275listener"]("click",(function(){p["\u0275\u0275restoreView"](n);var e=p["\u0275\u0275reference"](6);return t.onSearch(e.value)})),p["\u0275\u0275element"](8,"nb-icon",4),p["\u0275\u0275elementEnd"](),p["\u0275\u0275elementEnd"](),p["\u0275\u0275template"](9,b,1,2,"ng2-smart-table",5),p["\u0275\u0275elementEnd"](),p["\u0275\u0275elementEnd"]()}2&e&&(p["\u0275\u0275advance"](9),p["\u0275\u0275property"]("ngIf",t.userListReady&&t.userRolesReady))},directives:[h.r,h.t,h.q,h.D,h.I,h.o,h.eb,h.F,a.n,u.c],styles:[""]}),g)}],C=((v=function t(){e(this,t)}).\u0275mod=p["\u0275\u0275defineNgModule"]({type:v}),v.\u0275inj=p["\u0275\u0275defineInjector"]({factory:function(e){return new(e||v)},imports:[[s.g.forChild(y)],s.g]}),v),k=i("3Pt+"),S=i("vTDv"),x=((w=function t(){e(this,t)}).\u0275mod=p["\u0275\u0275defineNgModule"]({type:w}),w.\u0275inj=p["\u0275\u0275defineInjector"]({factory:function(e){return new(e||w)},imports:[[a.c,C,h.u,h.pb,h.H,h.rb,h.R,h.J,S.a,h.E,h.ib,h.p,u.d,k.s]]}),w)}}])}();