!function(){function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{AfY8:function(n,i,a){"use strict";a.r(i),a.d(i,"InvoicesModule",(function(){return I}));var o=a("ofXK"),c=a("tyNb"),s=a("D/fu"),r=a("UgA8"),u=a("AytR"),l=a("RS3s"),d=a("pLZG"),m=a("lJxs"),f=a("fXoL"),b=a("aceb"),h=a("3Pt+");function v(e,t){if(1&e&&(f["\u0275\u0275elementStart"](0,"div",17),f["\u0275\u0275elementStart"](1,"h1"),f["\u0275\u0275text"](2,"Total"),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementStart"](3,"p"),f["\u0275\u0275text"](4),f["\u0275\u0275pipe"](5,"currency"),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementEnd"]()),2&e){var n=f["\u0275\u0275nextContext"]();f["\u0275\u0275advance"](4),f["\u0275\u0275textInterpolate"](f["\u0275\u0275pipeBind1"](5,1,n.invoiceTotal))}}var p,g,k,S=[{path:"",component:(p=function(){function n(t,i,a,o,c,s){e(this,n),this.router=t,this.toast=i,this.nbMenuService=a,this.invoiceApi=o,this.mailbankApi=c,this.courierService=s,this.bulkActions=[{title:"Mark as Paid",data:"Paid"},{title:"Mark as Unpaid",data:"Unpaid"},{title:"Send Via Email",data:"Send"},{title:"Regenerate Invoice",data:"Regenerate"},{title:"Delete Invoice",data:"Delete"}],this.settings={pager:{perPage:10},selectMode:"multi",actions:{add:!1,edit:!1,delete:!1,position:"right",custom:[{name:"View",title:'<i class="nb-expand before-dark"></i>'}]},add:{inputClass:"text-black",confirmCreate:!0,addButtonContent:'<i class="nb-plus"></i>',createButtonContent:'<i class="nb-checkmark"></i>',cancelButtonContent:'<i class="nb-close"></i>'},columns:{id:{title:"Id",width:"5px",type:"number",filter:!1,editable:!1,addable:!1},courierPackageId:{width:"10px",title:"Pkg Id",type:"number",filter:!1},customer:{title:"Customer",type:"string",filter:!1},manifestNumber:{width:"30px",title:"Manifest Number",type:"number",filter:!1},amount:{title:"Total",type:"number",filter:!1,editable:!1,addable:!1},status:{title:"Status",type:"string",filter:!1,editable:!1,addable:!1}}},this.showTable=!1,this.showPaid=!1,this.source=new l.b,this.selected=[],this.isAdmin=!1,this.isAdmin="administrator"===localStorage.getItem("role"),this.isAdmin||this.bulkActions.pop()}var i,a,o;return i=n,(a=[{key:"ngOnInit",value:function(){var e=this;this.bulkButtonSubscription=this.nbMenuService.onItemClick().pipe(Object(d.a)((function(e){return"bulk-actions-menu"===e.tag})),Object(m.a)((function(e){return{title:e.item.title,data:e.item.data}}))).subscribe((function(t){return e.bulkAction(t)})),this.getInvoices()}},{key:"ngOnDestroy",value:function(){this.bulkButtonSubscription.unsubscribe()}},{key:"resetSearch",value:function(e){(!e||e<=2)&&this.source.setFilter([])}},{key:"getInvoices",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unpaid";this.invoiceApi.find({where:{businessId:this.courierService.getId(),status:t},include:[{relation:"customer",scope:{fields:["id","firstName","lastName"],include:{relation:"mailboxes",scope:{fields:{id:!0,mailboxNumber:!0}}}}},{relation:"courierPackage",scope:{fields:{id:!0,manifestNumber:!0}}}],order:"id DESC"}).pipe(Object(m.a)((function(t){return t.map((function(t){return{id:t.id,courierPackageId:t.courierPackageId,sentInEmail:t.sentInEmail?"YES":"NO",amount:t.amount.toFixed(2),status:t.status,manifestNumber:t.courierPackage?t.courierPackage.manifestNumber:"N/A",customer:t.customer?"".concat(e.pad(t.customer.mailboxes[0].mailboxNumber),"\n              ").concat(t.customer.firstName," ").concat(t.customer.lastName):"Unknown"}}))}))).subscribe((function(t){e.source=new l.b(t)}))}},{key:"onSearch",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";""!==e&&this.source.setFilter([{field:"courierPackageId",search:e},{field:"id",search:e},{field:"amount",search:e},{field:"manifestNumber",search:e},{field:"customer",search:e}],!1)}},{key:"onUserRowSelect",value:function(e){this.selected=e.selected}},{key:"bulkAction",value:function(e){switch(e.data){case"Paid":case"Unpaid":this.bulkUpdateInvoiceStatus(e.data);break;case"Send":this.bulkSendInvoice();break;case"Regenerate":this.bulkRegenerateInvoices();break;case"Delete":this.bulkDelete();break;default:this.toast.default("Unrecognized action","Uhhhh! Inc")}}},{key:"bulkDelete",value:function(){var e=this,t=this.selected.map((function(e){return e.id}));0!==t.length&&this.invoiceApi.bulkDelete(t).subscribe((function(t){e.toast.success("".concat(t.success," invoices deleted successfully out of ").concat(t.total),"Process Complete"),e.getInvoices(),e.selected=[]}),(function(t){e.toast.danger("Failed to delete invoices","Failed")}))}},{key:"bulkUpdateInvoiceStatus",value:function(e){var t=this,n=this.selected.map((function(e){return e.id}));if(0!==n.length){if("Paid"===e&&!confirm("Marking these as paid will automatically send an invoice, Are you sure you want to continue?"))return;this.invoiceApi.bulkStatusChange(n,e).subscribe((function(n){t.toast.success("".concat(n.success," invoices successfully marked as ").concat(e," out of ").concat(n.total),"Process Complete"),t.getInvoices(),t.selected=[]}),(function(e){return t.toast.danger("Failed to update invoices "+e.message,"Failed!")}))}}},{key:"bulkRegenerateInvoices",value:function(){var e=this,t=this.selected.map((function(e){return e.id}));0!==t.length&&this.invoiceApi.bulkRegenerateInvoices(t).subscribe((function(t){e.toast.success("".concat(t.success," invoices successfully regenerated successfully out of ").concat(t.total),"Process Complete"),e.getInvoices(),e.selected=[]}),(function(t){return e.toast.danger("Failed to update invoices "+t.message,"Failed!")}))}},{key:"bulkSendInvoice",value:function(){var e=this,t=this.selected.map((function(e){return e.id}));t.length<=0||this.mailbankApi.bulkSendInvoices(t).subscribe((function(t){e.toast.success("Invoices queued up for sending.","Success!"),e.showPaid=!1,e.selected=[],e.getInvoices()}),(function(t){e.toast.danger(t.message,"Failed to Send Invoices")}))}},{key:"onDeleteConfirm",value:function(e){var t=this;window.confirm("Are you sure you want to delete?")?this.invoiceApi.deleteById(e.data.id).subscribe((function(n){t.toast.success("Invoice successfully deleted","Success!"),e.confirm.resolve()}),(function(n){t.toast.danger("Error deleting invoice "+n.message),e.confirm.reject()})):e.confirm.reject()}},{key:"toggleShowPaid",value:function(e){!0===e?this.getInvoices("Paid"):this.getInvoices()}},{key:"pad",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,n=""+e;n.length<t;)n="0"+n;return"".concat(this.courierService.getPrefix(),"-").concat(n)}},{key:"onCustomAction",value:function(e){console.log(e.data),"View"===e.action&&window.open("".concat(u.a.apiUrl,"/api/Invoices/preview?courierId=").concat(this.courierService.getId(),"&invoiceId=")+(e.data.manifestNumber?e.data.manifestNumber:e.data.courierPackageId))}},{key:"onLimitChange",value:function(e){this.settings.pager.perPage=e,this.source.setPaging(1,e)}},{key:"invoiceTotal",get:function(){return this.selected.reduce((function(e,t){return Number(e)+Number(t.amount)}),0)}}])&&t(i.prototype,a),o&&t(i,o),n}(),p.\u0275fac=function(e){return new(e||p)(f["\u0275\u0275directiveInject"](c.c),f["\u0275\u0275directiveInject"](b.mb),f["\u0275\u0275directiveInject"](b.U),f["\u0275\u0275directiveInject"](s.g),f["\u0275\u0275directiveInject"](s.k),f["\u0275\u0275directiveInject"](r.a))},p.\u0275cmp=f["\u0275\u0275defineComponent"]({type:p,selectors:[["ngx-invoices"]],decls:31,vars:6,consts:[[1,"flex-between"],[1,"search"],["placeholder","Search... Enter 3 or more characters","type","text","nbInput","",3,"keydown"],["search",""],["nbSuffix","","nbButton","","ghost","",3,"click"],["icon","search-outline","pack","eva"],[3,"ngModel","checkedChange","ngModelChange"],["nbButton","","status","success","nbContextMenuTag","bulk-actions-menu",3,"disabled","nbContextMenu"],[1,"invoice-table",3,"settings","source","userRowSelect","custom","deleteConfirm"],["placeholder","Page Limit",3,"selectedChange"],["value","10"],["value","25"],["value","50"],["value","100"],["value","500"],["value","1000"],["class","invoice-total",4,"ngIf"],[1,"invoice-total"]],template:function(e,t){if(1&e){var n=f["\u0275\u0275getCurrentView"]();f["\u0275\u0275elementStart"](0,"nb-card"),f["\u0275\u0275elementStart"](1,"nb-card-header"),f["\u0275\u0275text"](2," Invoices "),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementStart"](3,"nb-card-body"),f["\u0275\u0275elementStart"](4,"div",0),f["\u0275\u0275elementStart"](5,"div"),f["\u0275\u0275elementStart"](6,"nb-form-field",1),f["\u0275\u0275elementStart"](7,"input",2,3),f["\u0275\u0275listener"]("keydown",(function(){f["\u0275\u0275restoreView"](n);var e=f["\u0275\u0275reference"](8);return t.onSearch(e.value)})),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementStart"](9,"button",4),f["\u0275\u0275listener"]("click",(function(){f["\u0275\u0275restoreView"](n);var e=f["\u0275\u0275reference"](8);return t.onSearch(e.value)})),f["\u0275\u0275element"](10,"nb-icon",5),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementStart"](11,"nb-toggle",6),f["\u0275\u0275listener"]("checkedChange",(function(e){return t.toggleShowPaid(e)}))("ngModelChange",(function(e){return t.showPaid=e})),f["\u0275\u0275text"](12,"Show Paid"),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementStart"](13,"button",7),f["\u0275\u0275text"](14,"BULK ACTIONS"),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementStart"](15,"ng2-smart-table",8),f["\u0275\u0275listener"]("userRowSelect",(function(e){return t.onUserRowSelect(e)}))("custom",(function(e){return t.onCustomAction(e)}))("deleteConfirm",(function(e){return t.onDeleteConfirm(e)})),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementStart"](16,"nb-card-footer"),f["\u0275\u0275elementStart"](17,"nb-select",9),f["\u0275\u0275listener"]("selectedChange",(function(e){return t.onLimitChange(e)})),f["\u0275\u0275elementStart"](18,"nb-option",10),f["\u0275\u0275text"](19," 10 "),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementStart"](20,"nb-option",11),f["\u0275\u0275text"](21," 25 "),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementStart"](22,"nb-option",12),f["\u0275\u0275text"](23," 50 "),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementStart"](24,"nb-option",13),f["\u0275\u0275text"](25," 100 "),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementStart"](26,"nb-option",14),f["\u0275\u0275text"](27," 500 "),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementStart"](28,"nb-option",15),f["\u0275\u0275text"](29," 1000 "),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementEnd"](),f["\u0275\u0275elementEnd"](),f["\u0275\u0275template"](30,v,6,3,"div",16)}2&e&&(f["\u0275\u0275advance"](11),f["\u0275\u0275property"]("ngModel",t.showPaid),f["\u0275\u0275advance"](2),f["\u0275\u0275property"]("disabled",0===t.selected.length)("nbContextMenu",t.bulkActions),f["\u0275\u0275advance"](2),f["\u0275\u0275property"]("settings",t.settings)("source",t.source),f["\u0275\u0275advance"](15),f["\u0275\u0275property"]("ngIf",t.selected.length>0))},directives:[b.r,b.t,b.q,b.D,b.I,b.o,b.eb,b.F,b.nb,h.m,h.p,b.y,l.c,b.s,b.X,b.V,o.n],pipes:[o.d],styles:[""]}),p)}],y=((k=function t(){e(this,t)}).\u0275mod=f["\u0275\u0275defineNgModule"]({type:k}),k.\u0275inj=f["\u0275\u0275defineInjector"]({factory:function(e){return new(e||k)},imports:[[c.g.forChild(S)],c.g]}),k),I=((g=function t(){e(this,t)}).\u0275mod=f["\u0275\u0275defineNgModule"]({type:g}),g.\u0275inj=f["\u0275\u0275defineInjector"]({factory:function(e){return new(e||g)},imports:[[o.c,y,l.d,b.H,b.E,b.u,b.J,b.Y,b.p,b.ob,b.z,h.g]]}),g)}}])}();