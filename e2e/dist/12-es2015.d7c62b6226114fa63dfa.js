(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{AfY8:function(e,t,n){"use strict";n.r(t),n.d(t,"InvoicesModule",(function(){return f}));var i=n("ofXK"),s=n("tyNb"),a=n("D/fu"),o=n("UgA8"),c=n("AytR"),r=n("RS3s"),l=n("pLZG"),d=n("lJxs"),u=n("fXoL"),m=n("aceb"),h=n("3Pt+");function b(e,t){if(1&e&&(u["\u0275\u0275elementStart"](0,"div",17),u["\u0275\u0275elementStart"](1,"h1"),u["\u0275\u0275text"](2,"Total"),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementStart"](3,"p"),u["\u0275\u0275text"](4),u["\u0275\u0275pipe"](5,"currency"),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementEnd"]()),2&e){const e=u["\u0275\u0275nextContext"]();u["\u0275\u0275advance"](4),u["\u0275\u0275textInterpolate"](u["\u0275\u0275pipeBind1"](5,1,e.invoiceTotal))}}const p=[{path:"",component:(()=>{class e{constructor(e,t,n,i,s,a){this.router=e,this.toast=t,this.nbMenuService=n,this.invoiceApi=i,this.mailbankApi=s,this.courierService=a,this.bulkActions=[{title:"Mark as Paid",data:"Paid"},{title:"Mark as Unpaid",data:"Unpaid"},{title:"Send Via Email",data:"Send"},{title:"Regenerate Invoice",data:"Regenerate"},{title:"Delete Invoice",data:"Delete"}],this.settings={pager:{perPage:10},selectMode:"multi",actions:{add:!1,edit:!1,delete:!1,position:"right",custom:[{name:"View",title:'<i class="nb-expand before-dark"></i>'}]},add:{inputClass:"text-black",confirmCreate:!0,addButtonContent:'<i class="nb-plus"></i>',createButtonContent:'<i class="nb-checkmark"></i>',cancelButtonContent:'<i class="nb-close"></i>'},columns:{id:{title:"Id",width:"5px",type:"number",filter:!1,editable:!1,addable:!1},courierPackageId:{width:"10px",title:"Pkg Id",type:"number",filter:!1},customer:{title:"Customer",type:"string",filter:!1},manifestNumber:{width:"30px",title:"Manifest Number",type:"number",filter:!1},amount:{title:"Total",type:"number",filter:!1,editable:!1,addable:!1},status:{title:"Status",type:"string",filter:!1,editable:!1,addable:!1}}},this.showTable=!1,this.showPaid=!1,this.source=new r.b,this.selected=[],this.isAdmin=!1,this.isAdmin="administrator"===localStorage.getItem("role"),this.isAdmin||this.bulkActions.pop()}ngOnInit(){this.bulkButtonSubscription=this.nbMenuService.onItemClick().pipe(Object(l.a)(({tag:e})=>"bulk-actions-menu"===e),Object(d.a)(e=>({title:e.item.title,data:e.item.data}))).subscribe(e=>this.bulkAction(e)),this.getInvoices()}ngOnDestroy(){this.bulkButtonSubscription.unsubscribe()}resetSearch(e){(!e||e<=2)&&this.source.setFilter([])}getInvoices(e="Unpaid"){this.invoiceApi.find({where:{businessId:this.courierService.getId(),status:e},include:[{relation:"customer",scope:{fields:["id","firstName","lastName"],include:{relation:"mailboxes",scope:{fields:{id:!0,mailboxNumber:!0}}}}},{relation:"courierPackage",scope:{fields:{id:!0,manifestNumber:!0}}}],order:"id DESC"}).pipe(Object(d.a)(e=>e.map(e=>({id:e.id,courierPackageId:e.courierPackageId,sentInEmail:e.sentInEmail?"YES":"NO",amount:e.amount.toFixed(2),status:e.status,manifestNumber:e.courierPackage?e.courierPackage.manifestNumber:"N/A",customer:e.customer?`${this.pad(e.customer.mailboxes[0].mailboxNumber)}\n              ${e.customer.firstName} ${e.customer.lastName}`:"Unknown"})))).subscribe(e=>{this.source=new r.b(e)})}onSearch(e=""){""!==e&&this.source.setFilter([{field:"courierPackageId",search:e},{field:"id",search:e},{field:"amount",search:e},{field:"manifestNumber",search:e},{field:"customer",search:e}],!1)}onUserRowSelect(e){this.selected=e.selected}bulkAction(e){switch(e.data){case"Paid":case"Unpaid":this.bulkUpdateInvoiceStatus(e.data);break;case"Send":this.bulkSendInvoice();break;case"Regenerate":this.bulkRegenerateInvoices();break;case"Delete":this.bulkDelete();break;default:this.toast.default("Unrecognized action","Uhhhh! Inc")}}bulkDelete(){const e=this.selected.map(e=>e.id);0!==e.length&&this.invoiceApi.bulkDelete(e).subscribe(e=>{this.toast.success(`${e.success} invoices deleted successfully out of ${e.total}`,"Process Complete"),this.getInvoices(),this.selected=[]},e=>{this.toast.danger("Failed to delete invoices","Failed")})}bulkUpdateInvoiceStatus(e){const t=this.selected.map(e=>e.id);if(0!==t.length){if("Paid"===e&&!confirm("Marking these as paid will automatically send an invoice, Are you sure you want to continue?"))return;this.invoiceApi.bulkStatusChange(t,e).subscribe(t=>{this.toast.success(`${t.success} invoices successfully marked as ${e} out of ${t.total}`,"Process Complete"),this.getInvoices(),this.selected=[]},e=>this.toast.danger("Failed to update invoices "+e.message,"Failed!"))}}bulkRegenerateInvoices(){const e=this.selected.map(e=>e.id);0!==e.length&&this.invoiceApi.bulkRegenerateInvoices(e).subscribe(e=>{this.toast.success(`${e.success} invoices successfully regenerated successfully out of ${e.total}`,"Process Complete"),this.getInvoices(),this.selected=[]},e=>this.toast.danger("Failed to update invoices "+e.message,"Failed!"))}bulkSendInvoice(){const e=this.selected.map(e=>e.id);e.length<=0||this.mailbankApi.bulkSendInvoices(e).subscribe(e=>{this.toast.success("Invoices queued up for sending.","Success!"),this.showPaid=!1,this.selected=[],this.getInvoices()},e=>{this.toast.danger(e.message,"Failed to Send Invoices")})}onDeleteConfirm(e){window.confirm("Are you sure you want to delete?")?this.invoiceApi.deleteById(e.data.id).subscribe(t=>{this.toast.success("Invoice successfully deleted","Success!"),e.confirm.resolve()},t=>{this.toast.danger("Error deleting invoice "+t.message),e.confirm.reject()}):e.confirm.reject()}toggleShowPaid(e){!0===e?this.getInvoices("Paid"):this.getInvoices()}pad(e,t=5){let n=""+e;for(;n.length<t;)n="0"+n;return`${this.courierService.getPrefix()}-${n}`}onCustomAction(e){console.log(e.data),"View"===e.action&&window.open(`${c.a.apiUrl}/api/Invoices/preview?courierId=${this.courierService.getId()}&invoiceId=`+(e.data.manifestNumber?e.data.manifestNumber:e.data.courierPackageId))}get invoiceTotal(){return this.selected.reduce((function(e,t){return Number(e)+Number(t.amount)}),0)}onLimitChange(e){this.settings.pager.perPage=e,this.source.setPaging(1,e)}}return e.\u0275fac=function(t){return new(t||e)(u["\u0275\u0275directiveInject"](s.c),u["\u0275\u0275directiveInject"](m.mb),u["\u0275\u0275directiveInject"](m.U),u["\u0275\u0275directiveInject"](a.g),u["\u0275\u0275directiveInject"](a.k),u["\u0275\u0275directiveInject"](o.a))},e.\u0275cmp=u["\u0275\u0275defineComponent"]({type:e,selectors:[["ngx-invoices"]],decls:31,vars:6,consts:[[1,"flex-between"],[1,"search"],["placeholder","Search... Enter 3 or more characters","type","text","nbInput","",3,"keydown"],["search",""],["nbSuffix","","nbButton","","ghost","",3,"click"],["icon","search-outline","pack","eva"],[3,"ngModel","checkedChange","ngModelChange"],["nbButton","","status","success","nbContextMenuTag","bulk-actions-menu",3,"disabled","nbContextMenu"],[1,"invoice-table",3,"settings","source","userRowSelect","custom","deleteConfirm"],["placeholder","Page Limit",3,"selectedChange"],["value","10"],["value","25"],["value","50"],["value","100"],["value","500"],["value","1000"],["class","invoice-total",4,"ngIf"],[1,"invoice-total"]],template:function(e,t){if(1&e){const e=u["\u0275\u0275getCurrentView"]();u["\u0275\u0275elementStart"](0,"nb-card"),u["\u0275\u0275elementStart"](1,"nb-card-header"),u["\u0275\u0275text"](2," Invoices "),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementStart"](3,"nb-card-body"),u["\u0275\u0275elementStart"](4,"div",0),u["\u0275\u0275elementStart"](5,"div"),u["\u0275\u0275elementStart"](6,"nb-form-field",1),u["\u0275\u0275elementStart"](7,"input",2,3),u["\u0275\u0275listener"]("keydown",(function(){u["\u0275\u0275restoreView"](e);const n=u["\u0275\u0275reference"](8);return t.onSearch(n.value)})),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementStart"](9,"button",4),u["\u0275\u0275listener"]("click",(function(){u["\u0275\u0275restoreView"](e);const n=u["\u0275\u0275reference"](8);return t.onSearch(n.value)})),u["\u0275\u0275element"](10,"nb-icon",5),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementStart"](11,"nb-toggle",6),u["\u0275\u0275listener"]("checkedChange",(function(e){return t.toggleShowPaid(e)}))("ngModelChange",(function(e){return t.showPaid=e})),u["\u0275\u0275text"](12,"Show Paid"),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementStart"](13,"button",7),u["\u0275\u0275text"](14,"BULK ACTIONS"),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementStart"](15,"ng2-smart-table",8),u["\u0275\u0275listener"]("userRowSelect",(function(e){return t.onUserRowSelect(e)}))("custom",(function(e){return t.onCustomAction(e)}))("deleteConfirm",(function(e){return t.onDeleteConfirm(e)})),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementStart"](16,"nb-card-footer"),u["\u0275\u0275elementStart"](17,"nb-select",9),u["\u0275\u0275listener"]("selectedChange",(function(e){return t.onLimitChange(e)})),u["\u0275\u0275elementStart"](18,"nb-option",10),u["\u0275\u0275text"](19," 10 "),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementStart"](20,"nb-option",11),u["\u0275\u0275text"](21," 25 "),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementStart"](22,"nb-option",12),u["\u0275\u0275text"](23," 50 "),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementStart"](24,"nb-option",13),u["\u0275\u0275text"](25," 100 "),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementStart"](26,"nb-option",14),u["\u0275\u0275text"](27," 500 "),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementStart"](28,"nb-option",15),u["\u0275\u0275text"](29," 1000 "),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementEnd"](),u["\u0275\u0275elementEnd"](),u["\u0275\u0275template"](30,b,6,3,"div",16)}2&e&&(u["\u0275\u0275advance"](11),u["\u0275\u0275property"]("ngModel",t.showPaid),u["\u0275\u0275advance"](2),u["\u0275\u0275property"]("disabled",0===t.selected.length)("nbContextMenu",t.bulkActions),u["\u0275\u0275advance"](2),u["\u0275\u0275property"]("settings",t.settings)("source",t.source),u["\u0275\u0275advance"](15),u["\u0275\u0275property"]("ngIf",t.selected.length>0))},directives:[m.r,m.t,m.q,m.D,m.I,m.o,m.eb,m.F,m.nb,h.m,h.p,m.y,r.c,m.s,m.X,m.V,i.n],pipes:[i.d],styles:[""]}),e})()}];let g=(()=>{class e{}return e.\u0275mod=u["\u0275\u0275defineNgModule"]({type:e}),e.\u0275inj=u["\u0275\u0275defineInjector"]({factory:function(t){return new(t||e)},imports:[[s.g.forChild(p)],s.g]}),e})(),f=(()=>{class e{}return e.\u0275mod=u["\u0275\u0275defineNgModule"]({type:e}),e.\u0275inj=u["\u0275\u0275defineInjector"]({factory:function(t){return new(t||e)},imports:[[i.c,g,r.d,m.H,m.E,m.u,m.J,m.Y,m.p,m.ob,m.z,h.g]]}),e})()}}]);